name: AUTO_RESTART_MIDNIGHT_ZDNCH

on:
  workflow_dispatch:
  schedule:
    - cron: "0 17 * * *"   # 00:00 WIB (UTC+7)

jobs:
  auto-restart:
    runs-on: windows-latest
    timeout-minutes: 10

    steps:
      - name: ZDNCH - Check FXServer
        shell: pwsh
        run: |
          Write-Host "== MIDNIGHT CHECK FXSERVER =="

          $fx = Get-Process FXServer -ErrorAction SilentlyContinue

          if ($fx) {
            Write-Host "FXServer RUNNING (PID $($fx.Id)) - NO ACTION"
            exit 0
          }

          Write-Host "FXServer NOT RUNNING - RESTARTING..."

      - name: ZDNCH - Start FXServer
        shell: pwsh
        run: |
          $fxPath = "C:\ZDNCH\apps\fivem\FXServer.exe"
          $cfgPath = "C:\ZDNCH\apps\fivem\server.cfg"

          if (!(Test-Path $fxPath)) {
            Write-Error "FXServer.exe not found"
            exit 1
          }

          if (!(Test-Path $cfgPath)) {
            Write-Error "server.cfg not found"
            exit 1
          }

          Start-Process -FilePath $fxPath `
            -ArgumentList "+exec server.cfg" `
            -WorkingDirectory "C:\ZDNCH\apps\fivem" `
            -WindowStyle Hidden

          Write-Host "FXServer restarted successfully"

      - name: ZDNCH - Verify Restart
        shell: pwsh
        run: |
          Start-Sleep 5
          $fx = Get-Process FXServer -ErrorAction SilentlyContinue
          if ($fx) {
            Write-Host "VERIFY: FXServer RUNNING (PID $($fx.Id))"
          } else {
            Write-Error "VERIFY FAILED: FXServer still DOWN"
          }
