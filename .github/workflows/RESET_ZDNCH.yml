name: RESET_ZDNCH

on:
  workflow_dispatch:

jobs:
  reset-runner:
    runs-on: windows-latest
    timeout-minutes: 15

    steps:
      - name: ZDNCH RESET - Kill Heavy Processes
        shell: pwsh
        run: |
          Write-Host "== KILL HEAVY PROCESSES =="

          $targets = @(
            "FXServer",
            "FXServer.exe",
            "txAdmin",
            "node",
            "node.exe",
            "java",
            "java.exe",
            "cmd",
            "powershell"
          )

          foreach ($p in $targets) {
            Get-Process -Name $p -ErrorAction SilentlyContinue | Stop-Process -Force
          }

      - name: ZDNCH RESET - Clean Temp & Cache
        shell: pwsh
        run: |
          Write-Host "== CLEAN TEMP =="

          Remove-Item "$env:TEMP\*" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item "C:\Windows\Temp\*" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item "C:\ZDNCH\data\*" -Recurse -Force -ErrorAction SilentlyContinue

      - name: ZDNCH RESET - Reset Network Stack
        shell: pwsh
        run: |
          Write-Host "== RESET NETWORK =="

          ipconfig /flushdns
          netsh int ip reset
          netsh winsock reset

      - name: ZDNCH RESET - Restart Core Services
        shell: pwsh
        run: |
          Write-Host "== RESTART CORE SERVICES =="

          Restart-Service TermService -Force
          Restart-Service LanmanServer -Force
          Restart-Service LanmanWorkstation -Force

      - name: ZDNCH RESET - Firewall Cleanup
        shell: pwsh
        run: |
          Write-Host "== FIREWALL CLEAN =="

          netsh advfirewall firewall delete rule name="FiveM" | Out-Null
          netsh advfirewall firewall delete rule name="RDP-PUBLIC" | Out-Null

      - name: ZDNCH RESET - DONE
        shell: pwsh
        run: |
          Write-Host "==============================="
          Write-Host "ZDNCH RESET COMPLETE"
          Write-Host "Runner clean, siap dipakai lagi"
          Write-Host "==============================="
