name: CRAFTY_PAPER_ZDNCH_AUTO

on:
  workflow_dispatch:

jobs:
  infra:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
    # =====================
    # SYSTEM
    # =====================
    - name: Update System
      run: |
        sudo apt update -y
        sudo apt upgrade -y

    # =====================
    # DEPENDENCIES
    # =====================
    - name: Install Dependencies
      run: |
        sudo apt install -y \
          curl jq docker.io \
          openjdk-21-jre-headless \
          openssh-server

        sudo systemctl enable docker
        sudo systemctl start docker

    # =====================
    # SSH
    # =====================
    - name: Enable SSH
      run: |
        sudo systemctl enable ssh
        sudo systemctl start ssh

    # =====================
    # TAILSCALE
    # =====================
    - name: Install Tailscale
      run: curl -fsSL https://tailscale.com/install.sh | sh

    - name: Connect Tailscale
      run: |
        sudo tailscale up \
          --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} \
          --hostname=crafty-zdnch-${{ github.run_id }}

    # =====================
    # PLAYIT (DOCKER)
    # =====================
    - name: Start Playit (Docker)
      run: |
        sudo docker run -d \
          --name playit-agent \
          --restart unless-stopped \
          --network host \
          -e SECRET_KEY=${{ secrets.PLAYIT_SECRET_KEY }} \
          ghcr.io/playit-cloud/playit-agent:0.16

    # =====================
    # CRAFTY INSTALL
    # =====================
    - name: Install Crafty
      run: curl -s https://craftycontrol.com/install.sh | sudo bash

    - name: Configure Crafty Bind
      run: sudo sed -i 's/127.0.0.1/0.0.0.0/g' /opt/crafty/conf/crafty.yaml

    - name: Start Crafty
      run: |
        sudo systemctl daemon-reexec
        sudo systemctl enable crafty
        sudo systemctl start crafty
        sleep 15

    # =====================
    # AUTO-CREATE PAPER SERVER (CRAFTY API)
    # =====================
    - name: Auto Create Paper Server via Crafty API
      run: |
        CRAFTY_API="http://127.0.0.1:8000/api/v2"
        TOKEN="${{ secrets.CRAFTY_API_TOKEN }}"

        echo "‚û°Ô∏è Creating Paper server..."

        RESPONSE=$(curl -s -X POST "$CRAFTY_API/servers" \
          -H "Authorization: Bearer $TOKEN" \
          -H "Content-Type: application/json" \
          -d '{
            "name": "ZDNCH-Paper",
            "type": "minecraft-java",
            "loader": "paper",
            "version": "1.21.11",
            "memory": 2048,
            "port": 25565,
            "auto_start": true
          }')

        echo "$RESPONSE" | jq .

        SERVER_ID=$(echo "$RESPONSE" | jq -r '.data.id')

        echo "SERVER_ID=$SERVER_ID" >> $GITHUB_ENV

    # =====================
    # START SERVER (SAFETY)
    # =====================
    - name: Ensure Paper Server Started
      run: |
        curl -X POST \
          http://127.0.0.1:8000/api/v2/servers/$SERVER_ID/start \
          -H "Authorization: Bearer ${{ secrets.CRAFTY_API_TOKEN }}"

    # =====================
    # KEEP ALIVE + INFO
    # =====================
    - name: KEEP ALIVE & INFO
      run: |
        TS_IP=$(tailscale ip -4 | head -n 1)

        echo "========================================"
        echo "üî• AUTO PAPER SERVER READY üî•"
        echo ""
        echo "üõ†Ô∏è Crafty:"
        echo "- Panel : Cloudflare Tunnel"
        echo "- API   : ACTIVE"
        echo ""
        echo "üì¶ Paper Server:"
        echo "- Name  : ZDNCH-Paper"
        echo "- ID    : $SERVER_ID"
        echo "- Port  : 25565"
        echo ""
        echo "üéÆ Minecraft:"
        echo "- Access : Playit"
        echo ""
        echo "üîê SSH:"
        echo "- ssh runner@$TS_IP"
        echo ""
        echo "========================================"

        while true; do
          echo "[ZDNCH] Alive | Server=$SERVER_ID | $(date)"
          sleep 300
        done
