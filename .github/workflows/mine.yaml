name: CRAFTY_PAPER_ZDNCH

on:
  workflow_dispatch:

jobs:
  infra:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
    # =====================
    # SYSTEM
    # =====================
    - name: Update System
      run: |
        sudo apt update -y
        sudo apt upgrade -y

    # =====================
    # BASE DEPENDENCIES
    # =====================
    - name: Install Dependencies
      run: |
        sudo apt install -y curl jq openssh-server
        sudo systemctl enable ssh
        sudo systemctl start ssh

        # Docker SUDAH ADA di runner
        sudo systemctl start docker
        docker --version

    # =====================
    # TAILSCALE
    # =====================
    - name: Install Tailscale
      run: curl -fsSL https://tailscale.com/install.sh | sh

    - name: Connect Tailscale
      run: |
        sudo tailscale up \
          --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} \
          --hostname=crafty-zdnch-${{ github.run_id }}

    # =====================
    # PLAYIT (DOCKER)
    # =====================
    - name: Start Playit (Docker)
      run: |
        sudo docker run -d \
          --name playit-agent \
          --restart unless-stopped \
          --network host \
          -e SECRET_KEY=${{ secrets.PLAYIT_SECRET_KEY }} \
          ghcr.io/playit-cloud/playit-agent:0.16

    # =====================
    # CRAFTY 4 (DOCKER - OFFICIAL)
    # =====================
    - name: Start Crafty Controller (Docker)
      run: |
        mkdir -p docker/{backups,logs,servers,config,import}

        sudo docker run -d \
          --name crafty_container \
          --restart unless-stopped \
          -p 8443:8443 \
          -p 8123:8123 \
          -p 19132:19132/udp \
          -p 25500-25600:25500-25600 \
          -e TZ=Etc/UTC \
          -v "$PWD/docker/backups:/crafty/backups" \
          -v "$PWD/docker/logs:/crafty/logs" \
          -v "$PWD/docker/servers:/crafty/servers" \
          -v "$PWD/docker/config:/crafty/app/config" \
          -v "$PWD/docker/import:/crafty/import" \
          registry.gitlab.com/crafty-controller/crafty-4:latest

        sleep 20

    # =====================
    # CLOUDFLARE TUNNEL (CRAFTY PANEL)
    # =====================
    - name: Start Cloudflare Tunnel (Crafty)
      run: |
        sudo docker run -d \
          --name crafty-cloudflared \
          --restart unless-stopped \
          cloudflare/cloudflared:latest \
          tunnel --no-autoupdate run \
          --token ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}

    # =====================
    # AUTO-CREATE PAPER SERVER (CRAFTY API)
    # =====================
    - name: Auto Create Paper Server
      run: |
        API="https://localhost:8443/api/v2"
        TOKEN="${{ secrets.CRAFTY_API_TOKEN }}"

        RESPONSE=$(curl -sk -X POST "$API/servers" \
          -H "Authorization: Bearer $TOKEN" \
          -H "Content-Type: application/json" \
          -d '{
            "name": "ZDNCH-Paper",
            "type": "minecraft-java",
            "loader": "paper",
            "version": "1.21.11",
            "memory": 2048,
            "port": 25565,
            "auto_start": true
          }')

        echo "$RESPONSE" | jq .
        echo "SERVER_ID=$(echo $RESPONSE | jq -r '.data.id')" >> $GITHUB_ENV

    # =====================
    # KEEP ALIVE + INFO
    # =====================
    - name: KEEP ALIVE & INFO
      run: |
        TS_IP=$(tailscale ip -4 | head -n 1)

        echo "========================================"
        echo "üî• CRAFTY 4 + PAPER READY üî•"
        echo ""
        echo "üõ† Crafty Panel:"
        echo "- https://<cloudflare-domain>"
        echo "- Port local : 8443"
        echo ""
        echo "üì¶ Paper:"
        echo "- Server ID : $SERVER_ID"
        echo "- Control   : FULL via Crafty"
        echo ""
        echo "üéÆ Minecraft:"
        echo "- Public via Playit"
        echo ""
        echo "üîê SSH:"
        echo "- ssh runner@$TS_IP"
        echo "========================================"

        while true; do
          echo "[ZDNCH] Alive $(date)"
          sleep 300
        done
