name: CRAFTY_PAPER_ZDNCH_MANUAL

on:
  workflow_dispatch:
    inputs:
      setup_playit:
        description: "Setup Playit (Minecraft Public Access)"
        type: boolean
        default: false
      setup_cloudflare:
        description: "Setup Cloudflare Tunnel (Crafty Panel)"
        type: boolean
        default: false
      setup_crafty:
        description: "Setup Crafty + Auto Create Paper Server"
        type: boolean
        default: false

jobs:
  infra:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
    # =====================
    # SYSTEM
    # =====================
    - name: Update System
      run: |
        sudo apt update -y
        sudo apt upgrade -y

    - name: Base Dependencies
      run: |
        sudo apt install -y curl jq openssh-server
        sudo systemctl enable ssh
        sudo systemctl start ssh
        sudo systemctl start docker

    # =====================
    # TAILSCALE (ALWAYS ON)
    # =====================
    - name: Install & Connect Tailscale
      run: |
        curl -fsSL https://tailscale.com/install.sh | sh
        sudo tailscale up \
          --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} \
          --hostname=crafty-zdnch-${{ github.run_id }}

    # =====================
    # PLAYIT (OPTIONAL)
    # =====================
    - name: Setup Playit (Docker)
      if: ${{ inputs.setup_playit }}
      run: |
        sudo docker run -d \
          --name playit-agent \
          --restart unless-stopped \
          --network host \
          -e SECRET_KEY=${{ secrets.PLAYIT_SECRET_KEY }} \
          -e AGENT_NAME=mine1 \
          ghcr.io/playit-cloud/playit-agent:0.16

        echo "PLAYIT ACTIVE"

    # =====================
    # CLOUDFLARE (OPTIONAL)
    # =====================
    - name: Setup Cloudflare Tunnel
      if: ${{ inputs.setup_cloudflare }}
      run: |
        sudo docker run -d \
          --name crafty-cloudflared \
          --restart unless-stopped \
          cloudflare/cloudflared:latest \
          tunnel --no-autoupdate run \
          --token ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}

        echo "CLOUDFLARE TUNNEL ACTIVE"

    # =====================
    # CRAFTY + PAPER (OPTIONAL)
    # =====================
    - name: Setup Crafty Controller
      if: ${{ inputs.setup_crafty }}
      run: |
        mkdir -p docker/{backups,logs,servers,config,import}

        sudo docker run -d \
          --name crafty_container \
          --restart unless-stopped \
          -p 8443:8443 \
          -p 8123:8123 \
          -p 19132:19132/udp \
          -p 25500-25600:25500-25600 \
          -e TZ=Etc/UTC \
          -v "$PWD/docker/backups:/crafty/backups" \
          -v "$PWD/docker/logs:/crafty/logs" \
          -v "$PWD/docker/servers:/crafty/servers" \
          -v "$PWD/docker/config:/crafty/app/config" \
          -v "$PWD/docker/import:/crafty/import" \
          registry.gitlab.com/crafty-controller/crafty-4:latest

        sleep 20

    - name: Auto Create Paper Server
      if: ${{ inputs.setup_crafty }}
      run: |
        API="https://localhost:8443/api/v2"
        TOKEN="${{ secrets.CRAFTY_API_TOKEN }}"

        RESPONSE=$(curl -sk -X POST "$API/servers" \
          -H "Authorization: Bearer $TOKEN" \
          -H "Content-Type: application/json" \
          -d '{
            "name": "ZDNCH-Paper",
            "type": "minecraft-java",
            "loader": "paper",
            "version": "1.21.11",
            "memory": 2048,
            "port": 25565,
            "auto_start": true
          }')

        echo "$RESPONSE" | jq .

    # =====================
    # FINAL INFO
    # =====================
    - name: FINAL INFO
      run: |
        TS_IP=$(tailscale ip -4 | head -n 1)

        echo "========================================"
        echo "ðŸ”¥ MANUAL INFRA WORKFLOW DONE ðŸ”¥"
        echo ""
        echo "Playit      : ${{ inputs.setup_playit }}"
        echo "Cloudflare  : ${{ inputs.setup_cloudflare }}"
        echo "Crafty      : ${{ inputs.setup_crafty }}"
        echo ""
        echo "SSH : ssh runner@$TS_IP"
        echo "========================================"

        while true; do
          echo "[ZDNCH] Alive $(date)"
          sleep 300
        done
