name: CRAFTY_PAPER_ZDNCH_MANUAL

on:
  workflow_dispatch:
    inputs:
      setup_playit:
        description: "Setup Playit (Minecraft Public Access)"
        type: boolean
        default: false
      setup_cloudflare:
        description: "Setup Cloudflare Tunnel (Crafty Panel)"
        type: boolean
        default: false
      setup_crafty:
        description: "Setup Crafty + Paper"
        type: boolean
        default: false

jobs:
  infra:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:

    - name: Free Root
      run: |
        git clone https://github.com/foxytouxxx/freeroot.git
        cd freeroot
        bash root.sh -yes
    # =====================
    # SYSTEM
    # =====================
    - name: Update System
      run: |
        sudo apt update -y
        sudo apt upgrade -y

    # =====================
    # SSH + USER (BEST EFFORT)
    # =====================
    - name: Setup SSH & User (Symbolic)
      run: |
        sudo apt install -y openssh-server
        sudo systemctl enable ssh
        sudo systemctl start ssh

        # create user
        sudo useradd -m admin || true
        echo "admin:admin123" | sudo chpasswd
        sudo usermod -aG sudo admin

        # ssh config (WILL NOT MAKE IT VPS)
        sudo sed -i 's/#PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config
        sudo sed -i 's/#PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config

        sudo systemctl restart ssh

        echo "USER admin CREATED (NON-PERSISTENT)"

    # =====================
    # BASE DEPENDENCIES
    # =====================
    - name: Base Dependencies
      run: |
        sudo apt install -y curl jq
        sudo systemctl start docker

    # =====================
    # TAILSCALE
    # =====================
    - name: Install & Connect Tailscale
      run: |
        curl -fsSL https://tailscale.com/install.sh | sh
        sudo tailscale up \
          --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} \
          --hostname=crafty-zdnch-${{ github.run_id }}

    # =====================
    # PLAYIT
    # =====================
    - name: Setup Playit
      if: ${{ inputs.setup_playit }}
      run: |
        sudo docker run -d \
          --name playit-agent \
          --restart unless-stopped \
          --network host \
          -e SECRET_KEY=${{ secrets.PLAYIT_SECRET_KEY }} \
          ghcr.io/playit-cloud/playit-agent:0.16

    # =====================
    # CLOUDFLARE
    # =====================
    - name: Setup Cloudflare Tunnel
      if: ${{ inputs.setup_cloudflare }}
      run: |
        sudo docker run -d \
          --name crafty-cloudflared \
          --restart unless-stopped \
          cloudflare/cloudflared:latest \
          tunnel --no-autoupdate run \
          --token ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}

    # =====================
    # CRAFTY
    # =====================
    - name: Setup Crafty Controller
      if: ${{ inputs.setup_crafty }}
      run: |
        mkdir -p docker/{backups,logs,servers,config,import}

        sudo docker run -d \
          --name crafty_container \
          --restart unless-stopped \
          -p 8443:8443 \
          -p 25500-25600:25500-25600 \
          -v "$PWD/docker:/crafty" \
          registry.gitlab.com/crafty-controller/crafty-4:latest

    # =====================
    # FINAL + KEEP ALIVE
    # =====================
    - name: FINAL INFO
      run: |
        TS_IP=$(tailscale ip -4 | head -n 1)

        echo "========================================"
        echo "üî• WORKFLOW ACTIVE üî•"
        echo "Playit     : ${{ inputs.setup_playit }}"
        echo "Cloudflare : ${{ inputs.setup_cloudflare }}"
        echo "Crafty     : ${{ inputs.setup_crafty }}"
        echo ""
        echo "SSH (symbolic): ssh admin@$TS_IP"
        echo "PASS: admin123"
        echo "‚ö†Ô∏è NOT A VPS ‚ö†Ô∏è"
        echo "========================================"

        while true; do
          echo "[ZDNCH] Alive $(date)"
          sleep 300
        done
