name: RDP_ZDNCH

on:
  workflow_dispatch:

jobs:
  rdp-public:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: ZDNCH DEV - Enable RDP Core
        shell: pwsh
        run: |
          Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
            -Name fDenyTSConnections -Value 0 -Force

          Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
            -Name UserAuthentication -Value 0 -Force
          Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
            -Name SecurityLayer -Value 0 -Force

          Restart-Service TermService -Force

      - name: ZDNCH DEV - Kill Unneeded Services (Safe)
        shell: pwsh
        run: |
          # IIS OFF
          iisreset /stop | Out-Null
          Stop-Service W3SVC -Force -ErrorAction SilentlyContinue
          Stop-Service WAS -Force -ErrorAction SilentlyContinue
          Set-Service W3SVC -StartupType Disabled
          Set-Service WAS -StartupType Disabled
          dism /online /disable-feature /featurename:IIS-WebServerRole /norestart

          # Windows Update OFF
          Stop-Service wuauserv -Force -ErrorAction SilentlyContinue
          Set-Service wuauserv -StartupType Disabled
          Stop-Service UsoSvc -Force -ErrorAction SilentlyContinue
          Set-Service UsoSvc -StartupType Disabled

          # Telemetry OFF
          Stop-Service DiagTrack -Force -ErrorAction SilentlyContinue
          Set-Service DiagTrack -StartupType Disabled
          Stop-Service dmwappushservice -Force -ErrorAction SilentlyContinue
          Set-Service dmwappushservice -StartupType Disabled

          # Search Index OFF
          Stop-Service WSearch -Force -ErrorAction SilentlyContinue
          Set-Service WSearch -StartupType Disabled

          # Defender soften
          Set-MpPreference -DisableRealtimeMonitoring $true
          Set-MpPreference -DisableBehaviorMonitoring $true
          Set-MpPreference -DisableIOAVProtection $true
          Set-MpPreference -DisableBlockAtFirstSeen $true

      - name: ZDNCH DEV - Prepare Work Directories
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path C:\ZDNCH | Out-Null
          takeown /f C:\ZDNCH /r /d y | Out-Null
          icacls C:\ZDNCH /grant Administrators:F /t | Out-Null

      - name: ZDNCH DEV - Create RDP User
        shell: pwsh
        run: |
          $chars = @{
            U=[char[]](65..90); L=[char[]](97..122)
            N=[char[]](48..57)
            S=([char[]](33..47)+[char[]](58..64)+[char[]](91..96)+[char[]](123..126))
          }
          $p=@()
          $p+=$chars.U|Get-Random -Count 4
          $p+=$chars.L|Get-Random -Count 4
          $p+=$chars.N|Get-Random -Count 4
          $p+=$chars.S|Get-Random -Count 4
          $pass=-join($p|Sort-Object{Get-Random})

          $sec=ConvertTo-SecureString $pass -AsPlainText -Force
          if(-not(Get-LocalUser RDP -ErrorAction SilentlyContinue)){
            New-LocalUser RDP -Password $sec -AccountNeverExpires
          }
          Add-LocalGroupMember Administrators RDP -ErrorAction SilentlyContinue
          Add-LocalGroupMember "Remote Desktop Users" RDP -ErrorAction SilentlyContinue

          echo "RDP_USER=RDP" >> $env:GITHUB_ENV
          echo "RDP_PASS=$pass" >> $env:GITHUB_ENV

      - name: ZDNCH DEV - Open Public RDP Firewall
        shell: pwsh
        run: |
          netsh advfirewall firewall delete rule name="RDP-PUBLIC" | Out-Null
          netsh advfirewall firewall add rule name="RDP-PUBLIC" `
            dir=in action=allow protocol=TCP localport=3389 remoteip=0.0.0.0/0

      - name: ZDNCH DEV - Show Public IP
        shell: pwsh
        run: |
          $pub = (Invoke-WebRequest -UseBasicParsing ifconfig.me).Content
          echo "PUBLIC_IP=$pub" >> $env:GITHUB_ENV
          Write-Host "Public IP: $pub"

      - name: ZDNCH DEV - Keep Alive
        shell: pwsh
        run: |
          Write-Host "=== RDP_ZDNCH READY (PUBLIC) ==="
          Write-Host "IP   : $env:PUBLIC_IP"
          Write-Host "Port : 3389"
          Write-Host "User : $env:RDP_USER"
          Write-Host "Pass : $env:RDP_PASS"
          Write-Host "================================"
          while($true){ Start-Sleep 300 }
