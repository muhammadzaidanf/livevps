name: AUTO_DOWNLOAD_ZDNCH

on:
  workflow_dispatch:

jobs:
  download-deps:
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
      - name: ZDNCH - Prepare BLACKHARBOR Directory
        shell: pwsh
        run: |
          $base = "C:\BLACKHARBOR\fivem"
          $res  = "$base\resources"

          New-Item -ItemType Directory -Force -Path $base | Out-Null
          New-Item -ItemType Directory -Force -Path $res  | Out-Null

          takeown /f C:\BLACKHARBOR /r /d y | Out-Null
          icacls C:\BLACKHARBOR /inheritance:e /t
          icacls C:\BLACKHARBOR /grant "Users":(OI)(CI)F /t
          icacls C:\BLACKHARBOR /grant "Administrators":(OI)(CI)F /t


      - name: ZDNCH - Install 7zip (portable)
        shell: pwsh
        run: |
          $bin = "C:\7zr.exe"
          if (!(Test-Path $bin)) {
            Invoke-WebRequest https://www.7-zip.org/a/7zr.exe -OutFile $bin
          }

      - name: ZDNCH - Download FXServer (BLACKHARBOR)
        shell: pwsh
        run: |
          $fxDir = "C:\BLACKHARBOR\fivem"
          $exe   = "$fxDir\FXServer.exe"

          if (Test-Path $exe) {
            Write-Host "FXServer already exists, skip"
            exit 0
          }

          $url = "https://runtime.fivem.net/artifacts/fivem/build_server_windows/master/24079-679adafe5e79e6d9e517aba4f03443677785e0d7/server.7z"
          $arc = "$env:TEMP\fxserver.7z"

          Invoke-WebRequest $url -OutFile $arc
          & C:\7zr.exe x $arc "-o$fxDir" -y
          Remove-Item $arc -Force

          if (!(Test-Path $exe)) {
            throw "FXServer.exe NOT FOUND â€” extract failed"
          }

      - name: ZDNCH - Download Default Resources
        shell: pwsh
        run: |
          $target = "C:\BLACKHARBOR\fivem\resources\[cfx-server-data]"

          if (Test-Path $target) {
            Write-Host "cfx-server-data already exists"
            exit 0
          }

          git clone https://github.com/citizenfx/cfx-server-data.git $target

      - name: ZDNCH - Verify BLACKHARBOR
        shell: pwsh
        run: |
          Write-Host "=== VERIFY BLACKHARBOR ==="
          Test-Path C:\BLACKHARBOR\fivem\FXServer.exe
          Get-ChildItem C:\BLACKHARBOR\fivem
          Write-Host "=========================="

      - name: ZDNCH - DONE
        shell: pwsh
        run: |
          Write-Host "================================="
          Write-Host "BLACKHARBOR FiveM READY"
          Write-Host "Path : C:\BLACKHARBOR\fivem"
          Write-Host "User : RDP (FULL ACCESS)"
          Write-Host "================================="
